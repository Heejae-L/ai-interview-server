<!DOCTYPE html>
<html>
<head>
  <title>AI Interview</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
  <h2>AI Interview System</h2>

  <!-- 이력서 텍스트 입력 -->
  <div class="mb-3">
    <h5>Enter Your Resume Information:</h5>
    <textarea id="resumeText" class="form-control" rows="10" placeholder="Write your resume content here..."></textarea>
    <button onclick="submitResume()" class="btn btn-primary mt-2">Generate Questions</button>
  </div>

  <!-- 질문 출력 -->
  <div class="mb-3">
    <h5>Generated Questions:</h5>
    <ul id="questionList"></ul>
  </div>

  <!-- 영상 촬영 및 업로드 -->
  <div class="mb-3">
    <h5>Interview Video</h5>
    <button onclick="startRecording()" class="btn btn-success">Start</button>
    <button onclick="stopRecording()" class="btn btn-danger">Stop & Upload</button>
    <video id="preview" autoplay muted class="mt-2" style="width: 100%; max-width: 640px;"></video>
  </div>

  <!-- 서버 응답 상태 -->
  <div class="mb-3">
    <p id="statusMessage" class="text-success"></p>
  </div>

  <!-- 분석 결과 -->
  <div class="mb-3">
    <h5>Interview Analysis Result:</h5>
    <p id="resultText"></p>
  </div>

  <script>
    let mediaRecorder, recordedChunks = [], resumeId = "";
    const BASE_URL = "https://ai-interview.onrender.com"; // Render 서버 주소

    async function submitResume() {
      const resumeText = document.getElementById("resumeText").value;
      document.getElementById("statusMessage").innerText = "Resume sent. Waiting for questions...";
      
      const res = await fetch(`${BASE_URL}/upload_resume_text`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: resumeText })
      });

      const data = await res.json();
      resumeId = data.resume_id;

      const list = document.getElementById("questionList");
      list.innerHTML = "";
      data.questions.forEach(q => {
        const li = document.createElement("li");
        li.innerText = q;
        list.appendChild(li);
      });

      document.getElementById("statusMessage").innerText = "Questions generated successfully.";
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      document.getElementById("preview").srcObject = stream;
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.start();
    }

    async function stopRecording() {
      mediaRecorder.stop();
      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });

        // 카메라 스트림 종료
        const videoElement = document.getElementById("preview");
        const stream = videoElement.srcObject;
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          videoElement.srcObject = null;
        }

        document.getElementById("statusMessage").innerText = "Uploading video...";

        const formData = new FormData();
        formData.append("file", blob);
        formData.append("resume_id", resumeId);

        await fetch(`${BASE_URL}/upload_video`, { method: "POST", body: formData });

        const res = await fetch(`${BASE_URL}/get_result/${resumeId}`);
        const data = await res.json();
        document.getElementById("resultText").innerText = data.result;

        document.getElementById("statusMessage").innerText = "Video uploaded and analysis complete.";
      };
    }
  </script>
</body>
</html>
