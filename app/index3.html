<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI ëª¨ì˜ ë©´ì ‘ ì‹œìŠ¤í…œ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 40px; }
    input[type="file"] { margin-bottom: 10px; }
    button { margin-top: 5px; padding: 5px 10px; }
    textarea, pre { width: 100%; min-height: 100px; margin-top: 10px; white-space: pre-wrap; }
    #videoElement { width: 480px; height: 360px; background: #eee; margin-top: 10px; }
  </style>
</head>
<body>

<h1>ğŸ§  AI ëª¨ì˜ ë©´ì ‘ ì‹œìŠ¤í…œ</h1>

<!-- 1. ì´ë ¥ì„œ ì—…ë¡œë“œ ë° ë¶„ì„ -->
<h2>1. ì´ë ¥ì„œ ë¶„ì„</h2>
<input type="file" id="resumeFile">
<button onclick="uploadResume()">ë¶„ì„</button>
<pre id="resumeResult"></pre>

<!-- 2. ì§ˆë¬¸ ìƒì„± -->
<h2>2. ì§ˆë¬¸ ìƒì„±</h2>
<input type="file" id="resumeForQuestions">
<button onclick="generateQuestions()">ì§ˆë¬¸ ìƒì„±</button>
<ol id="questionList"></ol>

<!-- 3. ì¸í„°ë·° ì˜ìƒ ë…¹í™” ë° ì €ì¥ -->
<h2>3. ì¸í„°ë·° ë…¹í™”</h2>
<button onclick="startRecording()">ë…¹í™” ì‹œì‘</button>
<button onclick="stopRecordingAndUpload()">ë…¹í™” ì¢…ë£Œ ë° ì˜ìƒ ì—…ë¡œë“œ</button>
<video id="videoElement" autoplay muted></video>

<!-- 4. ì§ˆë¬¸ ìŒì„± ì¶œë ¥ -->
<h2>4. ì§ˆë¬¸ ìŒì„± ì¶œë ¥</h2>
<button onclick="speakQuestions()">ì§ˆë¬¸ ì½ê¸°</button>

<!-- 5. ë¶„ì„ ê²°ê³¼ ì¶œë ¥ (ì›¹ìº  ê¸°ë°˜ ë…¹í™”ëœ ì˜ìƒ) -->
<h2>5. ì›¹ìº  ë…¹í™” ì˜ìƒ ë¶„ì„ ê²°ê³¼</h2>
<pre id="log"></pre>

<!-- 6. ì €ì¥ëœ ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„ -->
<h2>6. ì €ì¥ëœ ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„</h2>
<input type="file" id="videoFileUpload">
<button onclick="uploadVideoFile()">ë¶„ì„ ì‹œì‘</button>
<pre id="fileUploadLog"></pre>

<script>
  let generatedQuestions = [];
  let mediaRecorder;
  let recordedChunks = [];

  async function uploadResume() {
    const fileInput = document.getElementById('resumeFile');
    if (!fileInput.files.length) return alert("ì´ë ¥ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    const res = await fetch('/parse_resume', { method: 'POST', body: formData });
    const data = await res.json();
    document.getElementById('resumeResult').textContent = JSON.stringify(data, null, 2);
  }

  async function generateQuestions() {
    const fileInput = document.getElementById('resumeForQuestions');
    if (!fileInput.files.length) return alert("ì´ë ¥ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    const res = await fetch('/generate_questions', { method: 'POST', body: formData });
    const data = await res.json();
    const list = document.getElementById('questionList');
    list.innerHTML = '';
    generatedQuestions = data.questions;
    data.questions.forEach(q => {
      const li = document.createElement('li');
      li.textContent = q;
      list.appendChild(li);
    });
  }

  async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const videoEl = document.getElementById("videoElement");
    videoEl.srcObject = stream;

    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) recordedChunks.push(e.data);
    };
    mediaRecorder.start();
    alert("ë…¹í™” ì‹œì‘ë¨");
  }

  function stopRecordingAndUpload() {
    if (!mediaRecorder) return alert("ë¨¼ì € ë…¹í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.");

    mediaRecorder.stop();
    const videoEl = document.getElementById("videoElement");

    mediaRecorder.onstop = () => {
      // ì¹´ë©”ë¼ ë„ê¸°
      const stream = videoEl.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        videoEl.srcObject = null; // í™”ë©´ì—ì„œ ì œê±°
      }

      const blob = new Blob(recordedChunks, { type: "video/webm" });
      const formData = new FormData();
      formData.append("file", blob, "interview_recording.webm");

      fetch("/pose/analyze", {
        method: "POST",
        body: formData,
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("log").textContent = data.log_content;
        alert("ë…¹í™” ì˜ìƒ ë¶„ì„ ì™„ë£Œ");
      })
      .catch(err => {
        console.error(err);
        alert("ë¶„ì„ ì‹¤íŒ¨: " + err);
      });
    };
  }


  function speakQuestions() {
    if (generatedQuestions.length === 0) return alert("ë¨¼ì € ì§ˆë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.");
    const utterance = new SpeechSynthesisUtterance(generatedQuestions.join(". ë‹¤ìŒ ì§ˆë¬¸. "));
    utterance.lang = 'ko-KR';
    speechSynthesis.speak(utterance);
  }

  async function uploadVideoFile() {
    const fileInput = document.getElementById('videoFileUpload');
    if (!fileInput.files.length) return alert("ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.");

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    fetch("/pose/analyze", {
      method: "POST",
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("fileUploadLog").textContent = data.log_content;
      alert("íŒŒì¼ ì˜ìƒ ë¶„ì„ ì™„ë£Œ");
    })
    .catch(err => {
      console.error(err);
      alert("ë¶„ì„ ì‹¤íŒ¨: " + err);
    });
  }
</script>

</body>
</html>
